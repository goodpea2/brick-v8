# Brick Breaker - Design Document

This document outlines the design and mechanics of the p5.js Brick Breaker game, serving as a guideline for development.

## Core Gameplay Loop

The game is a modern take on the classic brick breaker genre, incorporating rogue-like progression, resource management, and deep customization. The player aims a ball, launches it, and destroys bricks on the screen. The primary goal is to destroy all designated "Goal Bricks" to advance to the next level.

*   **Aiming & Firing**: The player clicks and drags to aim a trajectory line, then releases to fire the ball.
*   **Ball Health**: The player's ball has Health Points (HP). It loses HP by hitting walls. If the ball's HP reaches zero, it is destroyed. The run ends if all balls are lost.
*   **Power-ups**: Most ball types have a limited number of special abilities (power-ups) that can be activated by clicking while the ball is in motion.
*   **Combos**: Hitting bricks sequentially without hitting a wall builds a combo, which can trigger powerful end-of-turn rewards.

---

## Game Modes

The game features four distinct modes: Adventure Run, Trial Run, Invasion Defend, and Home Base.

### Adventure Run

This is the main rogue-like mode where players progress through increasingly difficult levels, collecting resources and temporary upgrades.

*   **Progression**: Each run starts at Level 1 (or a higher milestone level) and continues until the player runs out of balls. Player XP, Gems, and main level are persistent between runs.
*   **Resources**:
    *   **Coins (ðŸª™)**: Dropped from bricks as they are damaged. Spent in the Shop on temporary upgrades. Resets after each run.
    *   **Gems (ðŸ’Ž)**: A premium currency occasionally found in bricks. Used for permanent upgrades in the Skill Tree.
    *   **Food (ðŸ¥•) & Wood (ðŸªµ)**: Dropped from bricks. These resources are taken back to the Home Base after the run.

### Trial Run

A pure skill-based mode that challenges players to see how far they can get with a limited, pre-selected set of balls.

*   **Ball System**: The run starts by consuming all consumable balls stored in the `Empty Cage` buildings in the player's Home Base. This becomes the player's entire ball inventory for the run. These balls are permanently lost if destroyed during the run.
*   **No Shop or Equipment**: There are no coins, shop upgrades, or equipment drops in this mode.
*   **End Condition**: The run ends when the player's last ball is used. Any unused balls are refunded to the Home Base, provided there is empty space in the `Empty Cage`s.
*   **Separate Records**: Trial Runs have their own "Highest Level Reached" record, tracked independently of Adventure Runs.

### Invasion Defend

A tower-defense style mode where the player defends their existing Home Base layout from waves of attacking NPC balls.

*   **Goal**: Survive as many waves as possible. The game ends if all **Goal Bricks** in the base are destroyed.
*   **Enemies**: NPC balls spawn from the edges of the screen and attack bricks. They have different behaviors (Basic, Fast, Explode, Piercing, Shooting).
*   **Economy**: Destroying NPCs drops Coins (unique to the current Invasion run) and Enchanters (Loot).
*   **Shop**: Between waves, players can spend Coins to place new bricks (Normal, Shield Gen) or apply defensive Overlays (Spike, Sniper) to existing bricks.

### Home Base

A persistent base-building and resource management mode that unlocks after the player's first Adventure Run. There is no active brick-breaking gameplay here.

*   **Gameplay**: Players place and upgrade buildings on a grid to generate resources passively over time. These resources can be spent to craft new buildings or produce consumable balls for Trial Runs. The layout can be rearranged using the "Edit Base" mode.
*   **Resources**:
    *   **Food (ðŸ¥•)**: Generated by `Farmland` buildings. Used to purchase certain buildings and produce balls. `Farmland` stores produced food internally up to its `localResourceCapacity` if no target bricks are nearby. It stops producing if full.
    *   **Wood (ðŸªµ)**: Generated by `Sawmill` buildings. Used to purchase buildings. `Sawmill` attempts to spawn `LogBrick` nearby. If blocked, it stores wood internally up to `localResourceCapacity`. It stops producing if full.
*   **Buildings**: Key buildings include `Farmland`, `Sawmill`, resource `Storage`, `Ball Producers`, and `Empty Cages`.

---

## Technical Architecture

### Event System (`eventManager.js`)
The game uses a publish/subscribe pattern to decouple game logic from specific systems, particularly Equipment.
*   **Dispatch**: Core logic (`sketch.js`, `brick.js`, `ball.js`) dispatches events like `BallHitWall`, `BrickDestroyed`, `TurnStart`.
*   **Listeners**: `equipmentManager.js` listens to these events to apply passive effects (e.g., healing on hit, exploding on wall contact) without cluttering the core physics code.

### Game Controller
The `gameController` object in `index.js` acts as a bridge between the DOM/UI layer (HTML/CSS/JS modules) and the p5.js canvas logic. It exposes methods like `resetGame`, `upgradeBrick`, and `startNextWave` to the UI buttons.

### State Management (`state.js`)
A singleton `state` object holds all persistent data (XP, Resources, Unlocks), current run data (Coins, Stats), and configuration settings. This ensures data consistency across different modules.

---

## Progression & Feature Unlocks

The game features a persistent progression system based on the player's main XP Level. **XP, Main Level, Gems, and Home Base progress are never reset.**

New features unlock as the player gains levels:

*   **After 1st Run**: **Home Base** mode is unlocked.
*   **Level 2**: `ExplosiveBall` unlocked.
*   **Level 3**: **Coins** and the **Shop** unlocked.
*   **Level 4**: **Combo System** (with Mine rewards) unlocked.
*   **Level 5**: **Gems (ðŸ’Ž)** and the **Skill Tree** unlocked.
*   **Level 6**: `SplitBall` unlocked.
*   **Level 7**: `ExplosiveBrick` spawns unlocked.
*   **Level 8**: Ability to **purchase Extra Balls** in the shop.
*   **Level 9**: `PiercingBall` unlocked.
*   **Level 10**: **Equipment System** unlocked.
*   **Level 11**: **Stripe Brick** combo rewards unlocked.
*   **Level 12**: `BrickBall` unlocked.
*   **Level 15**: `BulletBall` unlocked.
*   **Level 18**: `HomingBall` unlocked.
*   **Level 20**: **Special Bricks** (`WoolBrick`, `ShieldGenBrick`) unlocked.

---

## Core Systems

### Equipment System
Unlocked from Level 10, allowing players to customize balls with passive abilities.
*   **Acquisition**: Found in `Equipment` bricks or purchased in the Shop.
*   **Effects**: Handled dynamically via `equipmentManager.js`. Examples: `Vampirium` (Heal on brick break), `Kinetic Capacitor` (Charge damage on walls), `Ricochet Shotgun` (Fire bullets on wall hit).
*   **Rarity**: Common, Rare, Epic. Higher rarities have stronger effects.

### Enchantment System
Unlocked from the Home Base. Players use **Enchanters** (loot from Invasion Defend) to permanently upgrade Ball types.
*   **Mechanic**: Invest Enchanters to increase a success probability.
*   **Outcome**: On success, the ball levels up, gaining a permanent stat boost (HP, Damage, or Special) but increasing production cost.

### Skill Tree
Persistent upgrades purchased with Gems. Stats displayed in the UI (e.g., Explosive Damage Bonus) are dynamically calculated based on the number of upgrades purchased.

---

## Game Elements

### Ball Types

*   `classic`: Durable starting ball.
*   `explosive`: Power-up creates an area-of-effect explosion.
*   `piercing`: Power-up lets it phase through bricks.
*   `split`: Power-up splits it into multiple smaller balls.
*   `brick`: Power-up spawns a ring of new bricks (blockers).
*   `bullet`: Power-up fires 4 piercing projectiles.
*   `homing`: Power-up launches a projectile that seeks Goal bricks.
*   `giant`: A large, consumable ball that pierces all bricks but dies on wall contact.

### Brick Types

*   `normal`: Standard brick.
*   `goal`: Yellow brick. Destroy all to clear level.
*   `extraBall`: Green brick. Grants +1 Ball.
*   `explosive`: Orange brick. Explodes on death.
*   `stripe`: Red brick. Clears row/column.
*   `ballCage`: Releases a clone of the player's ball.
*   `wool`: Immune to indirect damage.
*   `shieldGen`: Projects damage-reduction aura.

### Brick Overlays (Applied to `normal` bricks)

*   `builder`: Spawns/buffs neighbors at end of turn.
*   `healer`: Heals neighbors at end of turn.
*   `mine`: Explodes when hit by ball.
*   `zapper`: Deals damage to ball within aura.
*   `zap_battery`: Increases `Zapper` range.
*   `spike`: Deals damage to the ball or NPC upon contact.
*   `sniper`: Turret that fires projectiles at the Player Ball (or NPCs in Invasion mode).
*   `laser`: Fires a continuous beam across the board that damages anything in its path.

### Tools & Utilities

*   **Level Editor**: Accessed via settings or "Edit Base". Allows placing/removing bricks, applying overlays, and modifying brick stats.
*   **Save/Load**: Export game state to a JSON string for backup or sharing.
*   **Import/Export Levels**: Share specific level layouts via string codes.